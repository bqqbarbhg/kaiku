/** @license Kaiku
 * kaiku.ts
 *
 * Copyright (c) 2021 Teemu Pääkkönen
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */const v=Symbol(),b=Symbol(),k=Symbol(),w=Symbol();var y;(function(t){t[t.HtmlTag=0]="HtmlTag",t[t.Component=1]="Component"})(y||(y={}));var c;(function(n){n[n.HtmlTag=0]="HtmlTag",n[n.Component=1]="Component",n[n.TextNode=2]="TextNode"})(c||(c={}));var m;(function(o){o[o.CreateText=0]="CreateText",o[o.CreateElement=1]="CreateElement",o[o.UpdateText=2]="UpdateText",o[o.UpdateElement=3]="UpdateElement"})(m||(m={}));function F(s){const r=Symbol();let t=0,n=!1,o=[],p=new Map,g=new Set,a=!1;function l(){const i=g;a=!1,g=new Set;for(const C of i)C();if(g.size)throw new Error("Side effects in render")}function E(){o.push(new Set),n=!0}function h(){n=!1;const i=o.pop();if(!i)throw new Error("stopDependencyTracking() called without a matching start call");return i}function e(i,C){p.has(i)||p.set(i,new Set),p.get(i).add(C)}function d(i,C){p.has(i)&&(p.get(i).delete(C),p.get(i).size===0&&p.delete(i))}function T(i){const C=++t,N=new Proxy(i,{get(f,u){switch(u){case k:return E;case w:return h;case v:return e;case b:return d;case r:return!0}if(typeof u=="symbol")return f[u];if(n){const S=C+"."+u;o[o.length-1].add(S)}return f[u]},set(f,u,S){if(typeof u=="symbol")return f[u]=S,!0;const H=C+"."+u;if(typeof S=="object"&&!S[r]?f[u]=T(S):f[u]=S,p.has(H)){a||(a=!0,window.queueMicrotask(l));for(const _ of p.get(H))g.add(_)}return!0}}),x=Object.keys(i);for(const f of x)N[f]=N[f];return N}return T(s)}function A(s,r,t){return{type:1,component:s,props:r,children:t}}function I(s,r){let t=new Set,n=null,o=s.props;function p(a=o){for(const E of t)r.state[b](E,p);r.state[k]();const l=s.component(a);t=r.state[w]();for(const E of t)r.state[v](E,p);l.type===1&&n?.type===1&&l.component===n.component?n.update(l.props):l.type===0&&n?.type===0&&l.tag===n.tag?n.update(l.props,l.children):(n&&n.destroy(),n=D(l,r)),o=a}function g(){n&&n.destroy();for(const a of t)r.state[b](a,p)}return p(),{type:1,component:s.component,update:p,destroy:g}}function U(s,r,t){return{type:0,tag:s,props:r,children:t}}function K(s,r){let t=[],n={};const o=document.createElement(s.tag);r.parentNode.appendChild(o);function p(a,l){const E=new Set([...Object.keys(a),...Object.keys(n)]);for(const e of E){if(n[e]===a[e])continue;if(e.startsWith("on")){const T=e.substr(2).toLowerCase();e in n&&o.removeEventListener(T,n[e]),e in a&&o.addEventListener(T,a[e])}else{if(e==="checked"){o.checked=!!a[e];continue}if(e==="value"&&e in a){o.value=a[e]??"";continue}e in a?o.setAttribute(e==="className"?"class":e,a[e]):o.removeAttribute(e)}}n=a;const h=[];for(const e of l.flat()){if(e===null||typeof e=="undefined"||typeof e=="boolean")continue;const d=t.findIndex(P=>typeof e=="string"||typeof e=="number"?P.type===2:e.type===0&&P.type===0?e.tag===P.tag:e.type===1&&P.type===1?e.component===P.component:!1);if(d===-1){typeof e=="string"||typeof e=="number"?h.push({type:0,value:e}):h.push({type:1,descriptor:e});continue}const T=t.splice(d,1)[0];if(T.type===2){h.push({type:2,node:T.node,value:e});continue}h.push({type:3,element:T,descriptor:e})}for(const e of t)e.type===2?o.removeChild(e.node):e.destroy();t=[];for(const e of h)switch(console.log(e),e.type){case 0:{const d=document.createTextNode(String(e.value));o.appendChild(d),t.push({type:2,node:d});continue}case 1:{t.push(D(e.descriptor,{state:r.state,parentNode:o}));continue}case 2:{const d=String(e.value);e.node.data!==d&&(e.node.data=d),t.push({type:2,node:e.node});continue}case 3:{e.element.update(e.descriptor.props,e.descriptor.children),t.push(e.element);continue}}}function g(){r.parentNode.removeChild(o);for(const a of t)a.type===2?o.removeChild(a.node):a.destroy()}return p(s.props,s.children),{type:0,tag:s.tag,destroy:g,update:p}}function D(s,r){return s.type===1?I(s,r):K(s,r)}function L(s,r,...t){switch(typeof s){case"function":return A(s,r??{},t);case"string":return U(s,r??{},t);default:throw new Error("Invalid constructor")}}function M(s,r,t){D(s,{state:r,parentNode:t})}export{L as h,M as render,F as createState};
